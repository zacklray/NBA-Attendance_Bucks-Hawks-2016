---
title: "Final Project"
author: "Ricardo del Olmo and Zack Ray"
date: "March 19, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=FALSE,fig.height=5,fig.width=7)
```

```{r,echo=FALSE,message=FALSE}
#These commands load the required packages and datasets. 

# echo=FALSE and message=FALSE prevents printing of system messages just associated with loading packages
# Don't change the following lines in this cod chunk
library(mosaic)
library(gmodels)
library(readr)
library(gridExtra)
BucksData <- read_csv("C:/Users/usuario/Desktop/MATH 360/Stats Project Data - Bucks.csv")
HawksData <- read_csv("C:/Users/usuario/Desktop/MATH 360/Stats Project Data - Hawks.csv")
```


**Background**

A large portion of the revenue generated by NBA teams stems from ticket sales, making up 21.97% of the total revenue.  The range in revenues created by tickets by team ranges from $19 million to $128 million for the Timberwolves and Knicks respectively.  For obvious reasons, teams want to maximize the revenue generated by ticket sales.  To capitalize on ticket sales, it is imperative to sell as many tickets as possible (obviously at reasonable prices, not selling tickets for virtually nothing).  With the idea of trying to sell as many tickets as possible, we pose the question: Under what conditions are teams most likely to sell tickets?  Are teams more likely to expect attendance on weekends vs weekdays? Do more spectators show up if the opposing team is especially good? And finally, is there evidence to show that the number of all-stars on the opposing team has an impact on attendance?


**Methods**

There are no public data sets that record information for every basketball game. Hence, we scraped data from ESPN for individual game attendance, team record, opposing team record, and the date the game was played (including day of the week).  We then used Basketball Reference to scrape data about all-stars on teams, and for trade information regarding all-stars to incorporate into our data set. Our data includes the 2016-2017 home games for the Atlanta Hawks and the Milwaukee Bucks.  There are 41 cases for each of these teams to be used in our analysis. 


**Choose Part I**

We plan on using a multiple logistic regression model that examines percentage attendance as a function of home team win percentage, opposing team win percentage, whether the game was played during the week or on the weekend (Friday, Saturday, and Sunday), and the number of two time-plus all stars on the opposing team. In order to calculate the attendance percentage for each game, we decided to make the maximum capacity of the arena one seat larger than the maximum capacity registered for any game during the 2016-2017 season (in order to successfully use logistic transformation of odds). For the Milwaukee Bucks data, we noticed that game attendance seemed higher for games played during the weekend. The first three graphs show attendance percentage with respect to the Bucks win percentage, the opposing team win percentage, and the number of two time-plus All-Stars in the opposing team (we have also including a categorical distinction for sellout games). It does not seem like there are any clear trends. We first created a multiple regression model that related attendance percentage for the Milwaukee Bucks home games with these factors. 

```{r,echo=FALSE}
BucksData = mutate(BucksData, pct.attendance = TotalAttendance/18718)
BucksData = mutate(BucksData, prop.attendance = log((pct.attendance)/(1-(pct.attendance))))
```

```{r,echo=FALSE}
plot1 = gf_point(pct.attendance~CombWinPct,color=~factor(SellOut), data = BucksData)%>%gf_labs(y="Attendance Percentage", x="Bucks Win Percentage", color = "Sell out")
plot2 = gf_point(pct.attendance~OppCombWinPct, data = BucksData, color=~factor(SellOut))%>%gf_labs(y="Attendance Percentage", x="Opponent Win Percentage",color = "Sell out")
plot3 = gf_jitter(pct.attendance~twoTimeAllStars, data = BucksData, color=~factor(SellOut),width=0.5)%>%gf_labs(y="Attendance Percentage", x="Two Time-Plus All-Stars",color = "Sell out")
grid.arrange(plot1,plot2,plot3,ncol=2)
```

Because the normal proportion plot for the regression showed multiple outliers that can be attributed to sell out games, we decided to model how these factors are associated with the probability of having a sell out game. To model this, we will use a logistic regression model in an attempt to describe the variance associated with the probability of selling out.  We also used a multiple linear regression model to explain the variance associated with proportion of attendance, of the games that were not sold out.

```{r,echo=FALSE}
plot1 = gf_point(SellOut~CombWinPct, color=~EndOrDay, data=BucksData)%>%gf_smooth()%>%gf_labs(y = "Did the Bucks Sell Out?", x = "Bucks Win Percentage", color = "Day of Week")
plot2 =gf_point(SellOut~OppCombWinPct, color=~EndOrDay, data=BucksData)%>%gf_smooth()%>%gf_labs(y = "Did the Bucks Sell Out?", x = "Opponent Win Percentage", color = "Day of Week")
plot3 = gf_point(SellOut~twoTimeAllStars, color=~EndOrDay, data=BucksData)%>%gf_smooth()%>%gf_labs(y = "Did the Bucks Sell Out?", x = "Two Time-Plus All-Stars", color = "Day of Week")
grid.arrange(plot1,plot2,plot3,ncol=2)
```


**Fit Part I**

```{r,echo=FALSE}
glm.attendance1=glm(SellOut~CombWinPct+OppCombWinPct+EndOrDay+twoTimeAllStars, data = BucksData, family=binomial)
summary(glm.attendance1)
```
Based on this logistic regression,

A 1% increase in win percentage of the Bucks is associated with a 9.58% increase in the odds of selling out for a given game.

A 1% increase in win percentage of the opposing team is associated with a 5.74% increase in the odds of selling out for a given game.

Holding all other factors constant, a game played during the weekend is 296.7% more likely to be sold out than a game played during the week.

An extra two time-plus All-Star is associated with a 31.3% decrease in the odds of selling out for a given game.

```{r,echo=FALSE}
bucks.1 = filter(BucksData, SellOut==0)
```


**Choose Part II**

As part of our post hoc analysis, we will look at our original research question without the inclusion of sold out crowds.  In our interpretation it is important to note that our analysis from this is all prefaced by the phrase "if the game is not sold out...".  Below are the graphs of the relationship between the log of the odds of a seat being taken and each of the independent variables.  From our graphs, it looks as though the odds of a seat being taken is generally higher for the weekend, and the other factors are loosely positively related to the odds of the seat being taken.  Also note that our normal probability plot looks much better after removing sell-out dates, meaning that our results are more reliable.

```{r,echo=FALSE}
plot1 = gf_point(prop.attendance~CombWinPct, color=~EndOrDay, data=bucks.1)%>%gf_smooth()%>%gf_labs(y = "Log Odds of a Seat Being Taken", x = "Bucks Win Percentage", color = "Day of Week")
plot2 = gf_point(prop.attendance~OppCombWinPct, color=~EndOrDay, data=bucks.1)%>%gf_smooth()%>%gf_labs(y = "Log Odds of a Seat Being Taken", x = "Opponent Win Percentage", color = "Day of Week")
plot3 = gf_point(prop.attendance~twoTimeAllStars, color=~EndOrDay, data=bucks.1)%>%gf_smooth()%>%gf_labs(y = "Log Odds of a Seat Being Taken", x = "Two Time-Plus All-Stars", color = "Day of Week")
grid.arrange(plot1,plot2,plot3,ncol=2)
```


**Fit Part II**

```{r,echo=FALSE}
lm.attendance3=lm(prop.attendance~CombWinPct+OppCombWinPct+EndOrDay+twoTimeAllStars, data = bucks.1)
summary(lm.attendance3)
```
Based on this regression, 

For every 10% increase in win percentage from the Bucks, we expect the odds of a given seat being taken to be 1.51 times greater.

For every 10% increase in win percentage for the opponent, we expect the odds of a given seat being taken to be 1.11 times greater.

Given all other factors are constant, we expect the odds of a given seat being filled to be 1.95 times greater for a weekend game versus a weekday game.

For each additional two time-plus all-star for a given opponent, we expect the odds of a given seat being taken to be 1.05 times greater.


**Choose Part III**

```{r,echo=FALSE}
HawksData = mutate(HawksData, pct.attendance = TotalAttendance/19445)
HawksData = mutate(HawksData, prop.attendance = log((pct.attendance)/(1-(pct.attendance))))
```

For the Atlanta Hawks data, we noticed that game attendance seemed higher for games played during the weekend. The first three graphs show attendance percentage with respect to the Bucks win percentage, the opposing team win percentage, and the number of two time-plus All-Stars in the opposing team (we have also including a categorical distinction for weekend games). It does not seem like there are any clear trends.  Because there are no sellout games, we do not have to take the same ad hoc approach as with the Milwaukee Bucks data.

```{r,echo=FALSE}
plot1 = gf_point(pct.attendance~CombWinPct, data = HawksData, color=~EndOrDay)%>%gf_labs(y="Attendance Percentage", x="Hawks Win Percentage", color = "Day of Week")
plot2 = gf_point(pct.attendance~OppCombWinPct, data = HawksData, color=~EndOrDay)%>%gf_labs(y="Attendance Percentage", x="Opponent Win Percentage", color = "Day of Week")
plot3 = gf_jitter(pct.attendance~twoTimeAllStars, data = HawksData, color=~EndOrDay, width=0.5)%>%gf_labs(y="Attendance Percentage", x="Two Time-Plus All-Stars", color = "Day of Week")
grid.arrange(plot1,plot2,plot3,ncol=2)
```

Below are the plots for the log odds of a given seat being taken based on the factors used in our regression model.  It seems like there are no clear relationship patterns with our variables and the log odds of a seat being taken, which is supported by our model, as shown later.

```{r,echo=FALSE}
plot1 = gf_point(prop.attendance~CombWinPct, color=~EndOrDay, data=HawksData)%>%gf_smooth()%>%gf_labs(y = "Log Odds of a Seat Being Taken", x = "Hawks Win Percentage", color = "Day of Week")
plot2 = gf_point(prop.attendance~OppCombWinPct, color=~EndOrDay, data=HawksData)%>%gf_smooth()%>%gf_labs(y = "Log Odds of a Seat Being Taken", x = "Opponent Win Percentage", color = "Day of Week")
plot3 = gf_point(prop.attendance~twoTimeAllStars, color=~EndOrDay, data=HawksData)%>%gf_smooth()%>%gf_labs(y = "Log Odds of a Seat Being Taken", x = "Two Time-Plus All-Stars", color = "Day of Week")
grid.arrange(plot1,plot2,plot3,ncol=2)
```


**Fit Part III**

```{r,echo=FALSE}
lm.attendance2=lm(prop.attendance~CombWinPct+OppCombWinPct+EndOrDay+twoTimeAllStars, data = HawksData)
summary(lm.attendance2)
```

For every 10% increase in win percentage for the Hawks, we can expect the odds of a given seat to be filled to be 0.5787 times greater (less, actually).

For every 10% increase in win percentage for the opponent, we can expect the odds of a given seat being filled to be 1.23 times greater.

Given all other factors constant, we expect the odds of a given seat being filled to be 1.52 times greater when the game is on a weekend versus a weekday.

For every additional two time plus all star on the opponents team, we expect the odds of a seat being filled to be 1.08 times greater.


**Conclusions**

Based on our regression models, we do not explain much of the variance involved with attendance at the games for the 2016-2017 season for the Atlanta Hawks and the Milwaukee Bucks. For Milwaukee, in games where the team does not sell out, our model explains about 37% of the variance in attendance.  This really is not explaining very much of the variance.  We believe that the exclusion of games that sell out is not an unreasonable assumption because the sell-out games were the first of the season, the last 3 games, when they played the defending champions Golden State, with a few anomalies.  In this regression, the only significant determinants at the .05 level are team win percentage and if it is a weekend or weekday.  Essentially, the idea being that there is generally more attendance if the team is doing better and if the game is on the weekend. The factors of opponent win percentage and number of two time all stars do not seem to be determinant of attendance percentage, for the Bucks.

For the Hawks, we only explain about 11% of the variation in attendance.  In our model, an increased win percentage has a negative relationship with attendance, which intuitively does not make sense.  Based on our data, I would say that there is no real relationship between any of our variables and attendance.  There is really no telling how many people will show up on a given night in Atlanta.  Part of this might be due the nature of Atlanta as a city: Atlanta has a high number of transplants in the city. This would mean a less energized fan base than those who grew up as a fan of the sports team in their city.  

Our recommendations for these teams are a mixed bag.  Obviously for both teams, you want to be the best team possible, and win the most games.  Even though our model shows that people are less likely to show up when the record is worse for Atlanta, it is in their best interest to win games and compete for the title and get playoff revenues.  Also, there are implications with attracting free agents.  Players obviously want to play for better teams to compete for titles, so winning is important even if our data says otherwise.  Also, it is just plain ridiculous to think that losing games would boost attendance.  While we expect both teams to have higher attendance, teams cannot schedule all home games on the weekends.  Rather teams should look at this and try to maximize attendance for games during weekdays by doing more advertising for these games.  Seems like weekend games should be able to advertise themselves and weekday games could benefit from special nights or promotional deals. The variables of teams win percentage and opposing team all-stars seem to have no real impact for the attendance, except cases like when these teams are playing Golden State.   
